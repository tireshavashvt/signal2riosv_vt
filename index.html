<!doctype html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ТИ решаваш! – Подай сигнал за замърсяване на въздуха</title>
  <link rel="preconnect" href="https://unpkg.com">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Montserrat:wght@600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" crossorigin="anonymous" />
  <script src="https://unpkg.com/docx@8.5.0/build/index.umd.js"></script>
  <style>
    body{margin:0;background:#f7faf9;color:#263238;font-family:'Inter',sans-serif;font-size:15px;line-height:1.5}
    header{padding:16px 20px;display:flex;align-items:center;gap:16px;max-width:1200px;margin:0 auto;background:#fff;
      box-shadow:0 4px 20px rgba(0,0,0,.06);border-radius:12px;margin-bottom:16px}
    .logo-placeholder{width:60px;height:60px;background:#2e7d6b;border-radius:10px;display:flex;align-items:center;
      justify-content:center;color:white;font-weight:700;font-size:20px;font-family:'Montserrat',sans-serif}
    header .brand h1{margin:0;font-size:20px;font-weight:700;color:#2e7d6b;font-family:'Montserrat',sans-serif}
    header .brand p{margin:4px 0 0;color:#6b7c83;font-size:14px}
    main{max-width:1200px;margin:0 auto;padding:0 16px 32px}
    .card{background:#fff;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,.06);padding:24px;margin-bottom:16px}
    .card h2{margin:0 0 20px;font-size:24px;color:#2e7d6b;font-weight:700;font-family:'Montserrat',sans-serif}
    .checks{display:grid;gap:4px}
    .check{display:flex;gap:10px;align-items:flex-start;padding:6px 10px;border-radius:8px;background:#f9f9f9}
    .check input{accent-color:#2e7d6b}
    .row{display:flex;gap:12px;flex-wrap:wrap;margin-top:20px}
    .btn{border:none;border-radius:10px;padding:12px 20px;font-weight:600;cursor:pointer;font-size:14px;
      background:#2e7d6b;color:#fff}
    .btn.secondary{background:#fff;color:#2e7d6b;border:2px solid #2e7d6b}
    .preview{white-space:pre-wrap;background:#fcfdfc;border:2px dashed #cfe2de;padding:16px;border-radius:10px;
      font-family:monospace;font-size:13px;line-height:1.4;max-height:300px;overflow-y:auto}
  </style>
</head>
<body>
  <header>
    <div class="logo-placeholder">ТИ</div>
    <div class="brand">
      <h1>ТИ решаваш! – Подай сигнал за замърсяване на въздуха</h1>
      <p>Гражданско сдружение „За Велико Търново"</p>
    </div>
  </header>

  <main>
    <form id="signalForm" class="card">
      <h2>Форма за сигнал</h2>

      <label>Предполагаем източник *</label>
      <select id="source" required>
        <option value="" disabled selected>Изберете източник...</option>
        <option>Трафик / автомобили</option>
        <option>Завод „Кроношпан"</option>
        <option>„Топлофикация"</option>
        <option>Завод „Мегапорт"</option>
        <option>Друг източник</option>
      </select>

      <label>Квартал *</label>
      <select id="district" required>
        <option value="" disabled selected>Изберете квартал...</option>
        <option>Чолаковци</option><option>Акация</option><option>Център</option>
        <option>Бузлуджа</option><option>Картала</option><option>Кольо Фичето</option>
        <option>Зона Б</option><option>Света гора</option><option>Друг</option>
      </select>

      <label>Кога е установено нарушението? *</label>
      <input id="when" type="datetime-local" required>

      <label>Адрес / район</label>
      <input id="address" type="text" placeholder="ул., №, ориентир...">

      <label>Влошаване на качеството на живот *</label>
      <div id="checks" class="checks"></div>

      <label>Име и фамилия *</label>
      <input id="name" type="text" required>

      <label>Имейл за обратна връзка *</label>
      <input id="email" type="email" required>

      <label>Телефон</label>
      <input id="phone" type="tel">

      <label>Допълнително описание</label>
      <textarea id="desc"></textarea>

      <div class="row">
        <button type="button" class="btn" id="downloadDocx">Свали DOCX</button>
        <button type="button" class="btn secondary" id="sendToRiosv">Изпрати към РИОСВ</button>
      </div>
    </form>

    <section class="card">
      <h3>Преглед на текста</h3>
      <div id="preview" class="preview"></div>
    </section>
  </main>

  <script>
    const checkboxItems = [
      "Наличие на остра, задушлива миризма на лепило.",
      "Наличие на остра, задушлива миризма на дървесина.",
      "Наличие на остра, задушлива миризма на лепило и дървесина.",
      "Наличие на остра, задушлива миризма на химикали.",
      "Наличие на остра, задушлива миризма, от която имам физическо неразположение – люти на очите.",
      "Наличие на остра, задушлива миризма, от която имам физическо неразположение – люти на носа.",
      "Наличие на остра, задушлива миризма, от която имам физическо неразположение – люти на гърлото.",
      "Наличие на остра, задушлива миризма, от която имам физическо неразположение – получавам задух.",
      "Наблюдава се обгазяване, задимяване, наличие на синкава мъгла.",
      "Наблюдава се силно запрашаване на въздуха.",
      "Наличие на дървени стърготини по колите.",
      "Чува се силен шум, тътен."
    ];
    const checksWrap = document.getElementById('checks');
    checkboxItems.forEach((txt,i)=>{
      const id="chk_"+i;
      const el=document.createElement('label');
      el.className='check';
      el.innerHTML=`<input type="checkbox" id="${id}" value="${txt}"><span>${txt}</span>`;
      checksWrap.appendChild(el);
    });

    // речник с адреси
    const sourceAddresses = {
      "Завод „Кроношпан\"": "гр. Велико Търново, кв. Чолаковци, ул. Дълга Лъка",
      "„Топлофикация\"": "гр. Велико Търново, бул. Никола Габровски 71А",
      "Завод „Мегапорт\"": "гр. Велико Търново, ул. Никола Габровски 102"
    };

    function formatDateTime(datetimeStr){
      if(!datetimeStr) return {date:"[дата]",time:"[час]"};
      const d=new Date(datetimeStr);
      const pad=n=>String(n).padStart(2,'0');
      return {
        date:`${pad(d.getDate())}.${pad(d.getMonth()+1)}.${d.getFullYear()}`,
        time:`${pad(d.getHours())}:${pad(d.getMinutes())}`
      };
    }
    function todayDate(){
      const d=new Date();
      const pad=n=>String(n).padStart(2,'0');
      return `${pad(d.getDate())}.${pad(d.getMonth()+1)}.${d.getFullYear()}`;
    }

    function collectData(){
      return {
        source:document.getElementById('source').value,
        district:document.getElementById('district').value,
        when:document.getElementById('when').value,
        address:document.getElementById('address').value,
        name:document.getElementById('name').value,
        email:document.getElementById('email').value,
        phone:document.getElementById('phone').value,
        desc:document.getElementById('desc').value,
        checks:Array.from(document.querySelectorAll('#checks input:checked')).map(c=>c.value)
      };
    }

    function buildLetterText(d){
      const {date,time}=formatDateTime(d.when);
      const header="ДО\nДИРЕКТОРА НА РИОСВ – ВЕЛИКО ТЪРНОВО\n\nСИГНАЛ";
      const fromLine=`От: ${[d.name,d.phone,d.email].filter(Boolean).join(" / ")}`;

      let intro="";
      if(sourceAddresses[d.source]){
        intro=`Моля за извършване на проверка на ${d.source}, находящ се в ${sourceAddresses[d.source]}, във връзка с нарушение, водещо до влошаване на качеството ми на живот, а именно :`;
      }else{
        intro=`Моля за извършване на проверка във връзка с нарушение, водещо до влошаване на качеството ми на живот, а именно :`;
      }

      const bullets=d.checks.length?d.checks.map(t=>"• "+t).join("\n"):"• [изберете поне една опция]";
      const violationLine=`Нарушението е установено на ${date} в ${time}`;
      const descLine=d.desc?`Допълнително описание: ${d.desc}`:"";
      const footer=`Моля за входящ номер, както и за отговор от Ваша страна в законоустановения срок.\n\nДата: ${todayDate()}    Подпис: ${d.name}`;

      return [header,fromLine,"",intro,bullets,violationLine,descLine,footer].filter(Boolean).join("\n\n");
    }

    function updatePreview(){preview.textContent=buildLetterText(collectData());}
    const preview=document.getElementById('preview');
    document.getElementById('signalForm').addEventListener('input',updatePreview);

    // DOCX download
    document.getElementById('downloadDocx').addEventListener('click',async()=>{
      const text=buildLetterText(collectData());
      const {Document,Packer,Paragraph,TextRun}=docx;
      const paras=text.split("\n").map(line=>new Paragraph({children:[new TextRun(line)]}));
      const doc=new Document({sections:[{children:paras}]});
      const blob=await Packer.toBlob(doc);
      const a=document.createElement('a');
      a.href=URL.createObjectURL(blob);
      a.download="signal_riosv_vt.docx";
      a.click();
      URL.revokeObjectURL(a.href);
    });

    updatePreview();
  </script>
</body>
</html>
